---
title: Java虚拟机：类加载器
categories:
  - Java
  - Java虚拟机
tags:
  - Java虚拟机
keyword:
  - Java虚拟机
  - 类加载器
  - 双亲委派
date: 2018-04-23 17:11:37
---

虚拟机把描述类的数据从Class字节码文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型，这就是虚拟机的类加载机制。

<!--more-->

## 1、类加载的时机

类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：加载(Loading)、验证、准备、解析、初始化、使用、卸载7个阶段，其中验证、准备、解析3个部分统称为连接，发生顺序如下图所示：
![类的生命周期][1]

加载、验证、准备、初始化、卸载这5个阶段的顺序是固定的，而解析则不一定：它在某些情况下可以在初始化之后再开始，这是为了支持Java的运行时绑定(也成动态绑定或晚期绑定)。

那么何时开始第一阶段加载呢？虚拟机规范没有强制约束，由虚拟机具体实现自由把握。
但初始化阶段，有且仅有5种情况必须立即初始化：

 1. 遇到new、getstatic、putstatic、invokestatic这4条字节码指令时，如果类没有进行过初始化，则需要先触发其初始化。生成这四条指令的最常见的Java代码场景:使用new关键字实例化对象的时候、读取或设置一个类的静态字段（被final修饰、已在编译期放入常量池的静态字段除外）的时候，以及调用一个类的静态方法的时候。
 2. 使用java.lang.reflect包的方法对类进行反射调用时，如果类没有初始化，则需先触发其初始化。
 3. 当初始化一个类时，若其父类还没有进行初始化，则需要先触发其父类初始化。
 4. 当虚拟机启动时，用户需要指定一个要执行的主类，虚拟机会先初始化这个主类。
 5. 当使用JDK1.7的动态语言支持时，如果一个java.lang.invoke.MethodHandle实例最后的解析结果是REF_getStatic、REF_putStatic、REF_invokeStatic的方法句柄，并且这个方法句柄对应的类没有初始化，则需要先触发其初始化。

## 2、类加载器

虚拟机团队吧类加载阶段中的“通过一个类的全限定名来获取描述此类的二进制字节流”这个动作放到Java虚拟机外部去实现，以便让应用程序自己决定如何去获取所需要的类。实现这个动作的代码模块称为“类加载器”。

类加载器虽然只用于实现类的加载动作，但它的作用却远远不限于类加载阶段。对于任意一个类，都需要由加载它的类加载器和这个类本身一同确立其在Java虚拟机中的唯一性，每一个类加载器，都有一个独立的命名空间。也就是说：比较两个类是否“相等”，只有在这两个类由同一个类加载器加载的前提下才有意义，否则，即使是来源于同一个Class文件，被同一个JVM加载，只要加载它们的类加载器不同，那么这两个类就必不相等。


**类加载器的分类：**

 1. 启动类加载器(Bootstrap ClassLoader):负责加载<JAVA_HOME>\lib目录中的，或者被-Xbootclasspath参数所指定的路径中的能被识别的类库。
 2. 扩展类加载器(Extension ClassLoader):负责加载<JAVA_HOME>\lib\ext目录中的，或者被java.ext.dirs系统变量所指定的路径中的所有类库，开发者可以直接使用该加载器。
 3. 应用程序加载器(Application ClassLoader):由ClassLoader中的getSystemClassLoader()方法获得，负责加载用户路径(classpath)上的类库。若果没有自定义加载器，一般情况下这就是程序的默认类加载器。


**双亲委派机制：**

 ![此处输入图片的描述][2]
  
除启动类加载器外，器与类加载器都应有自己的父类。

若果一个类收到类加载的请求，它首先不会自己去加载，而是委派给父类加载器去完成，依次往上，因此所有的加载请求最终都会传递到顶层的启动类加载器。只有当父类反馈自己无法加载，子类才会尝试去加载。

这样做的好处：
    使类加载器具备了优先级的层次关系，保证了同一个类始终是由同一个类加载器完成加载。

  [1]: https://raw.githubusercontent.com/kevinXiao2016/kevinXiao2016.github.io/hexo/imageStorage/JVM/ClassLife.jpg
  [2]: https://raw.githubusercontent.com/kevinXiao2016/kevinXiao2016.github.io/hexo/imageStorage/JVM/ParentsDelegationModel.jpg